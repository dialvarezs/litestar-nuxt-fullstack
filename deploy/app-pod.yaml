apiVersion: v1
kind: ConfigMap
metadata:
  name: app
data:
  TZ: UTC
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: app
  name: pod-app
spec:
  containers:
    - name: db
      image: postgres:18
      envFrom:
        - configMapRef:
            name: app
        - secretRef:
            name: app
      securityContext:
        runAsUser: 920
        runAsGroup: 920
      ports:
        - containerPort: 5432
      livenessProbe:
        exec:
          command: ["pg_isready"]
        initialDelaySeconds: 10
        periodSeconds: 10
      volumeMounts:
        - mountPath: /docker-entrypoint-initdb.d/:z
          name: app-db-init
          readOnly: true
        - mountPath: /var/lib/postgresql:Z,U
          name: app-db-pvc
        - mountPath: /var/run/postgresql:Z
          name: app-db-tmp

    - name: api
      image: app_api:latest
      env:
        - name: LITESTAR_WORKERS
          value: "1"
      envFrom:
        - configMapRef:
            name: app
        - secretRef:
            name: app
      securityContext:
        runAsUser: 921
        runAsGroup: 921
        readOnlyRootFilesystem: true
      ports:
        - containerPort: 8000
          hostPort: 10101
      livenessProbe:
        httpGet:
          path: /health/live
          port: 8000
        initialDelaySeconds: 15
        periodSeconds: 10
      volumeMounts:
        - mountPath: /app/config.toml:z
          name: app-api-config
          readOnly: true
        - mountPath: /tmp:Z
          name: app-api-tmp

    - name: web
      image: app_web:latest
      envFrom:
        - configMapRef:
            name: app
      securityContext:
        runAsUser: 922
        runAsGroup: 922
        readOnlyRootFilesystem: true
      ports:
        - containerPort: 3000
          hostPort: 10102
      livenessProbe:
        httpGet:
          path: /
          port: 3000
        initialDelaySeconds: 10
        periodSeconds: 10
      volumeMounts:
        - mountPath: /tmp:Z
          name: app-web-tmp

  volumes:
    - name: app-db-init
      hostPath:
        path: ./db_init/
        type: DirectoryOrCreate
    - name: app-api-config
      hostPath:
        path: ./api-config.toml
        type: File
    - name: app-db-pvc
      persistentVolumeClaim:
        claimName: app-db-pvc
    - name: app-db-tmp
      emptyDir: { }
    - name: app-api-tmp
      emptyDir: { }
    - name: app-web-tmp
      emptyDir: { }
